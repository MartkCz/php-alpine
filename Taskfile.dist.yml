version: 3

includes:
  tests: ./tests
  builder: ./variants/builder
  variants: ./variants

env:
  IMAGE: martkcz/php-alpine
  LATEST_VERSION: 8.5
  PHP_VERSIONS: [ 8.5, 8.4 ]

tasks:
  test:
    desc: 'Run all tests'
    cmds:
      - for:
          var: PHP_VERSIONS
          as: ITEM
        task: tests:run
        vars:
          IMAGE: '{{.IMAGE}}'
          PHP_VERSION: '{{.ITEM}}'
  build:
    desc: 'Build all variants and push to Docker Hub'
    cmds:
      - for:
          var: PHP_VERSIONS
          as: ITEM
        task: _build
        vars:
          PHP_VERSION: '{{.ITEM}}'
  push:
    desc: 'Push all variants to Docker Hub'
    cmds:
      - for:
          var: PHP_VERSIONS
          as: ITEM
        task: _push
        vars:
          PHP_VERSION: '{{.ITEM}}'
  _build:
    desc: 'Build image for specific PHP version'
    internal: true
    requires:
      vars: [ PHP_VERSION ]
    cmds:
      - task: builder:build
        vars:
          PHP_VERSION: '{{ .PHP_VERSION }}'
          IMAGE: '{{ .IMAGE }}'
      - task: variants:build-roadrunner
        vars:
          PHP_VERSION: '{{ .PHP_VERSION }}'
          IMAGE: '{{ .IMAGE }}'
      - task: variants:build
        vars:
          PHP_VERSION: '{{ .PHP_VERSION }}'
          IMAGE: '{{ .IMAGE }}'
  _push:
    desc: 'Push image for specific PHP version'
    internal: true
    requires:
      vars: [ PHP_VERSION ]
    cmds:
      - task: variants:push-roadrunner
        vars:
          PHP_VERSION: '{{ .PHP_VERSION }}'
          IMAGE: '{{ .IMAGE }}'
      - task: variants:push
        vars:
          PHP_VERSION: '{{ .PHP_VERSION }}'
          IMAGE: '{{ .IMAGE }}'
  php-version:
    desc: 'Print PHP version of the current image'
    cmds:
      - docker run --rm "{{ .IMAGE }}:{{ .LATEST_VERSION }}-builder" php -v
  default:
    cmds:
      - task: builder:build
      - task: variants:build-roadrunner
      - task: variants:build
      - task: variants:push-roadrunner
      - task: variants:push
